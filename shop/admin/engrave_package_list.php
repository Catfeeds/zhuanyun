<?php /** * ENGRAVE 商品管理、物流转运 程序 * ============================================================================ * 版权所有  zxp，并保留所有权利。 * 网站地址:  * 中文名称：包裹管理 * ============================================================================ * $Author: zxp $ * @changed : cfang  * $Id: engrave_package_list.php 2014-11-17 21:34:00 zxp $ */define('IN_ECS', true);require(dirname(__FILE__) . '/includes/init.php');/* 载入语言文件 */require_once(ROOT_PATH . 'languages/' .$_CFG['lang']. '/admin/engrave_package_list.php');/*载入-物流系统-数据访问文件*/require_once(ROOT_PATH . 'admin/includes/engrave/lib_package.php');require_once(ROOT_PATH . 'admin/includes/engrave/lib_package_attachs.php');require_once(ROOT_PATH . 'admin/includes/engrave/lib_member_manage.php');require_once(ROOT_PATH . 'admin/includes/engrave/lib_receive_warehouse.php');/*上传*/require_once (ROOT_PATH  . 'admin/commonhelper/upload_json.php');$smarty->assign('lang',$_LANG);/*------------------------------------------------------ *///-- 包裹管理列表:未到货/*------------------------------------------------------ */if ($_REQUEST['act'] == 'list'){    /* 检查权限 */    admin_priv('package_manage');	//获取包裹管理列表---数据	$package_list=engrave_package_list();	$smarty->assign('package_list', $package_list['package_list']);    $ur_here = $_LANG['01_package_manage'] .'｜'.$_LANG['0101_package_list'];    $smarty->assign('ur_here', $ur_here);    $smarty->assign('action_link',  array('text' => $_LANG['0102_add_waybill'], 'href'=>'engrave_package_list.php?act=add'));    $smarty->assign('filter',       $package_list['filter']);    $smarty->assign('record_count', $package_list['record_count']);    $smarty->assign('page_count',   $package_list['page_count']);        $smarty->assign('full_page',    1);    /* 显示商品列表页面 */    assign_query_info();        $smarty->display('engrave_package_list.htm');}/*------------------------------------------------------ *///-- 包裹管理列表:已过期/*------------------------------------------------------ */if ($_REQUEST['act'] == 'expiredlist'){    /* 检查权限 */    admin_priv('package_manage');	//获取包裹管理列表---数据	$package_list=engrave_package_list(0,'',2);	$smarty->assign('package_list', $package_list['package_list']);    $ur_here = $_LANG['01_package_manage'] .'｜'.$_LANG['0101_package_list'];    $smarty->assign('ur_here', $ur_here);    $smarty->assign('filter',       $package_list['filter']);    $smarty->assign('record_count', $package_list['record_count']);    $smarty->assign('page_count',   $package_list['page_count']);    $smarty->assign('type', 'expiredlist');    $smarty->assign('full_page',    1);    /* 显示商品列表页面 */    assign_query_info();        $smarty->display('engrave_package_list.htm');}/*------------------------------------------------------ *///-- 包裹管理列表:已删除/*------------------------------------------------------ */if ($_REQUEST['act'] == 'destroyedlist'){    /* 检查权限 */    admin_priv('package_manage');	//获取包裹管理列表---数据	$package_list=engrave_package_list(1,'',0);	$smarty->assign('package_list', $package_list['package_list']);    $ur_here = $_LANG['01_package_manage'] .'｜'.$_LANG['0101_package_list'];    $smarty->assign('ur_here', $ur_here);    $smarty->assign('filter',       $package_list['filter']);    $smarty->assign('record_count', $package_list['record_count']);    $smarty->assign('page_count',   $package_list['page_count']);    $smarty->assign('type', 'destroyedlist');    $smarty->assign('full_page',    1);    /* 显示商品列表页面 */    assign_query_info();        $smarty->display('engrave_package_list.htm');}elseif ($_REQUEST['act'] == 'query'){    //获取包裹管理列表---数据    $package_list=engrave_package_list();	$smarty->assign('package_list', $package_list['package_list']);    $smarty->assign('filter',       $package_list['filter']);    $smarty->assign('record_count', $package_list['record_count']);    $smarty->assign('page_count',   $package_list['page_count']);	    $sort_flag  = sort_flag($package_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    	make_json_result($smarty->fetch('engrave_package_list.htm'), '',			array('filter' => $package_list['filter'], 'page_count' => $package_list['page_count']));	}elseif ($_REQUEST['act'] == 'query_destroyed'){    //获取包裹管理列表---数据	$package_list=engrave_package_list(1,'',0);	$smarty->assign('package_list', $package_list['package_list']);    $smarty->assign('filter',       $package_list['filter']);    $smarty->assign('record_count', $package_list['record_count']);    $smarty->assign('page_count',   $package_list['page_count']);    $smarty->assign('type', 'destroyedlist');	    $sort_flag  = sort_flag($package_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    	make_json_result($smarty->fetch('engrave_package_list.htm'), '',			array('filter' => $package_list['filter'], 'page_count' => $package_list['page_count']));	}elseif($_REQUEST['act'] == 'userlist'){	/* 检查权限 */	admin_priv('package_manage');	$smarty->assign('full_page',    1);	$user_list= engrave_pack_users_list();	$smarty->assign('user_list',   $user_list['user_list']);	$smarty->assign('full_page',    1);	/* 显示用户组列表页面 */	assign_query_info();	$smarty->display('engrave_package_usergroup.htm');}elseif($_REQUEST['act'] == 'getusername'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$userId = !empty($_POST['userId']) ? intval($_POST['userId']) : '0';	$username = engrave_get_pack_username($userId);	echo $username;}elseif($_REQUEST['act'] == 'getstoragecode'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$userId = !empty($_POST['userId']) ? intval($_POST['userId']) : '0';	$storagecode = engrave_get_pack_storagecode($userId);	echo $storagecode;}elseif ($_REQUEST['act'] == 'getusernamebycode'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$storagecode = !empty($_POST['storagecode']) ? trim($_POST['storagecode']) : '';	$username = engrave_get_pack_usernamebycode($storagecode);	echo $username;}elseif ($_REQUEST['act'] == 'getuseridbycode'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$storagecode = !empty($_POST['storagecode']) ? trim($_POST['storagecode']) : '';	$userid = engrave_get_pack_useridbycode($storagecode);	echo $userid;}elseif ($_REQUEST['act'] == 'getsizeunit'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$houseId = !empty($_POST['houseid']) ? trim($_POST['houseid']) : '';	$sizeunit = engrave_get_sizeunit($houseId);	echo $sizeunit;}elseif ($_REQUEST['act'] == 'getweightunit'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$houseId = !empty($_POST['houseid']) ? trim($_POST['houseid']) : '';	$weightunit = engrave_get_weightunit($houseId);	echo $weightunit;}elseif ($_REQUEST['act'] == 'getcurrencycode'){	/* 检查权限 */	admin_priv('package_manage');	include_once(ROOT_PATH . 'includes/lib_clips.php');	$houseId = !empty($_POST['houseid']) ? trim($_POST['houseid']) : '';	$currencycode = engrave_get_currencycode($houseId);	echo $currencycode;}elseif($_REQUEST['act']=='add'){	/* 检查权限 */	admin_priv('package_manage');	$ur_here = $_LANG['01_package_manage'] .'｜'.$_LANG['0102_add_waybill'];	$smarty->assign('ur_here', $ur_here);	$ur_tip = empty($_LANG['engrave_package_info_tip'])?'':$_LANG['engrave_package_info_tip'];	$smarty->assign('ur_tip', $ur_tip);	/*取得货运公司列表 */	$smarty->assign('express_list', get_express_list());	/*取得购物网站列表 */	$smarty->assign('site_list', get_site_list());	//获取默认仓库	$warehouse = engrave_warehouse_default();	$smarty->assign('warehouse', $warehouse);	/*取得货物仓库列表 */	$smarty->assign('house_list', get_house_list());	$smarty->assign('action_link',  array('text' => $_LANG['0101_package_list'], 'href'=>'engrave_package_list.php?act=list'));	$smarty->assign('form_action', 'insert');	/* 显示优惠券页面 */	assign_query_info();	$smarty->display('engrave_package_info.htm');}elseif ($_REQUEST['act'] == 'edit'){	/* 检查权限 */	admin_priv('package_manage');		//获取ID，并根据ID获取对象 赋值给smarty	$PackageId=$_REQUEST['id'];	$package_info=engrave_package($PackageId);	$smarty->assign('package_info', $package_info);	//根据ID获取购物凭证	$shoppingvouchers_list = engrave_package_shoppingvouchers_bypckid($PackageId);	$smarty->assign('shoppingvouchers_list', $shoppingvouchers_list);	//根据ID获取附件	$package_attachs_list = engrave_package_attachs_list($PackageId);	//print_r($package_attachs_list);	$smarty->assign('package_attachs_list', $package_attachs_list);	//根据ID获取商品内物品	$packagegoods_list = engrave_packagegoods_bypckid($PackageId);	$smarty->assign('packagegoods_list', $packagegoods_list);		$ur_tip = empty($_LANG['engrave_package_info_tip'])?'':$_LANG['engrave_package_info_tip'];	$smarty->assign('ur_tip', $ur_tip);	/*取得货运公司列表 */	$smarty->assign('express_list', get_express_list());	/*取得购物网站列表 */	$smarty->assign('site_list', get_site_list());	/*取得货物仓库列表 */	$smarty->assign('house_list', get_house_list());	$smarty->assign('action_link',  array('text' => $_LANG['0101_package_list'], 'href'=>'engrave_package_list.php?act=list'));	$smarty->assign('form_action', 'update');	//获取增值服务	$package_service_list = engrave_package_services_list_bypckid($PackageId);	$smarty->assign('package_service_list',$package_service_list);	/* 显示优惠券页面 */	assign_query_info();	$smarty->display('engrave_package_info.htm');}/*------------------------------------------------------ *///-- 包裹的添加和编辑-数据操作/*------------------------------------------------------ */elseif($_REQUEST['act']=='insert' || $_REQUEST['act']=='update'){	$act=$_REQUEST['act'];	/* 检查权限 */	admin_priv('package_manage');	//获取数据	$package['pck_storagecode'] = !empty($_POST['StorageCode']) ? trim($_POST['StorageCode']) : '';	$package['pck_userid'] = !empty($_POST['UserCode']) ? intval($_POST['UserCode']) : '0';	$package['pck_expressid'] = !empty($_POST['ExpressId']) ? intval($_POST['ExpressId']) : '0';	$package['pck_expresstelephone'] = !empty($_POST['ExpressTelephone']) ? trim($_POST['ExpressTelephone']) : '';	$package['pck_expressnumber'] = !empty($_POST['ExpressNumber']) ? trim($_POST['ExpressNumber']) : '';	$package['pck_ordersite'] = !empty($_POST['OrderSite']) ? intval($_POST['OrderSite']) : '0';	$package['pck_ordernumber'] = !empty($_POST['OrderNumber']) ? trim($_POST['OrderNumber']) : '';	$package['pck_sizelength'] = !empty($_POST['SizeLength']) ?   doubleval($_POST['SizeLength']) : '0.00';	$package['pck_sizewidth'] = !empty($_POST['SizeWidth']) ? doubleval($_POST['SizeWidth']) : '0.00';	$package['pck_sizeheight'] = !empty($_POST['SizeHeight']) ? doubleval($_POST['SizeHeight']) : '0.00';	$package['pck_weight'] = !empty($_POST['Weight']) ? doubleval($_POST['Weight']) : '0.00';	$package['pck_assess'] = !empty($_POST['Assess']) ? doubleval($_POST['Assess']) : '0.00';	$package['pck_name'] = !empty($_POST['Name']) ? trim($_POST['Name']) : '';	$package['pck_userremark'] = !empty($_POST['UserRemark']) ? trim($_POST['UserRemark']) : '';	$package['pck_adminremark'] = !empty($_POST['AdminRemark']) ? trim($_POST['AdminRemark']) : '';	$package['pck_warehouseid'] = !empty($_POST['WareHouse']) ? intval($_POST['WareHouse']) : '0';	$package['pck_inventorylocation'] = !empty($_POST['InventoryLocation']) ? trim($_POST['InventoryLocation']) : '';	$package['pck_istrouble'] = !empty($_POST['IsTrouble']) ? intval($_POST['IsTrouble']) : '0';	$package['pck_packagestatus'] = !empty($_POST['PackageStatus']) ? intval($_POST['PackageStatus']) : '0';	$package['pck_intime'] = gmtime();//local_date('Y-m-d H:i:s',gmtime());	$package['pck_isdelete'] = '0';		//如果isset返回false，说明disabled为true，默认值为1	$package['pck_isaward'] = isset($_POST['s_forecastaward']) ? intval($_POST['s_forecastaward']) : 1;		if($act=='insert')	{		engrave_package_insert($package);		//修改用户存款		engrave_member_money_update($_EFG['s_forecastaward'],$package['pck_userid']);		//页面跳转		$link[0]['text'] = $_LANG['continue_add_package'];		$link[0]['href'] = 'engrave_package_list.php?act=add';		$link[1]['text'] = $_LANG['back_package_list'];		$link[1]['href'] = 'engrave_package_list.php?act=list';	}	elseif($act=='update')	{		$PackageId=!empty($_REQUEST['id']) ? intval($_REQUEST['id']) : '0';		$isaward = engrave_package_isaward($PackageId);		//修改用户存款		if(!$isaward && $package['pck_isaward']==1)		{			//系统值为0，用户输入值为1			engrave_package_isaward_update($PackageId);			engrave_member_money_update($_EFG['s_forecastaward'],$package['pck_userid']);		}		elseif($isaward && $package['pck_isaward']==0)		{			//系统值为1，用户输入值为0			$package['pck_isaward']=1;		}				engrave_package_update($package,$PackageId);				$link[0]['text'] = $_LANG['back_package_list'];		$link[0]['href'] = 'engrave_package_list.php?act=list';	}	sys_msg($_LANG['save_success'], 0, $link);}/*------------------------------------------------------ *///-- 包裹订单删除：数据操作/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'remove'){	$PackageId = intval($_REQUEST['id']);	/* 检查权限 */	check_authz_json('package_remove');	if (engrave_package_delete("1", $PackageId))	{		//$goods_name = $exc->get_name($cntId);		//admin_log(addslashes($goods_name), 'trash', 'goods'); // 记录日志		$url = 'engrave_package_list.php?act=query&' . str_replace('act=remove', '', $_SERVER['QUERY_STRING']);		ecs_header("Location: $url\n");		exit;		//$lnk[] = array('text' => $_LANG['go_back'], 'href'=>'engrave_pre_recharge_card.php?act=list');		//sys_msg(sprintf($_LANG['remove_card_success'], $count), 0, $lnk);	}}/*------------------------------------------------------ *///-- 包裹订单删除-恢复：数据操作/*------------------------------------------------------ */elseif($_REQUEST['act'] == 'remove_return'){	$PackageId = intval($_REQUEST['id']);	/* 检查权限 */	check_authz_json('package_remove');	if (engrave_package_delete("0", $PackageId))	{		$url = 'engrave_package_list.php?act=query_destroyed&' . str_replace('act=remove_return', '', $_SERVER['QUERY_STRING']);		ecs_header("Location: $url\n");		exit;	}}/*------------------------------------------------------ *///-- 包裹 上传文件/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'upload'){	//建立数据库连接	$charset = 'gbk';	$charset = strtolower(str_replace('-', '', EC_CHARSET));		$conn = mysql_connect($engrave_db_host, $engrave_db_user, $engrave_db_pass, $engrave_db_name);	mysql_query("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary",$conn);	mysql_query('START TRANSACTION',$conn);		$link[0]['text'] = $_LANG['back_package_list'];	$link[0]['href'] = 'engrave_package_list.php?act=list';			$pck_id = isset($_REQUEST['pck_id']) ? intval($_REQUEST['pck_id']) : 0;	$upload=new FileUpload();	$attachs['pa_packageid'] = $pck_id;	foreach ($_FILES AS $code => $file)	{		$filename = $upload-> upload_image($file);		if($filename!='error')		{			$attachs['pa_attach'] = $filename;			if(!engrave_package_attachs_insert($attachs,$conn))			{				transaction_failed($conn);				sys_msg($_LANG['save_failed'], 0, $link);			}		}		else {			sys_msg($_LANG['save_failed'], 0, $link);		}	}	transaction_success($conn);	sys_msg($_LANG['save_success'], 0, $link);}/**************************************************************************************** * 打印 ***************************************************************************************/elseif($_REQUEST['act'] == 'print'){	$package_id =isset($_REQUEST['package_id']) ? trim($_REQUEST['package_id']) : '';	if($package_id!='')	{		$package_list = engrave_package_in($package_id);		$package_list[0]['pck_intime_format'] = date('Y-m-d H:i', $package_list[0]['pck_intime'] );		//print_a($package_list);		$smarty->assign('package_list', $package_list);	}	$smarty->display('engrave_package_print.htm');}/**************************************************************************************** * 打印:过期 ***************************************************************************************/elseif($_REQUEST['act'] == 'print_outtime'){	$package_id =isset($_REQUEST['package_id']) ? trim($_REQUEST['package_id']) : '';	if($package_id!='')	{		$package_list = engrave_package_in($package_id);		$smarty->assign('package_list', $package_list);	}	$smarty->display('engrave_package_print_outtime.htm');}/**************************************************************************************** * 批量：入库 ***************************************************************************************/elseif($_REQUEST['act'] == 'batch_instorage'){	//建立数据库连接	$charset = 'gbk';	$charset = strtolower(str_replace('-', '', EC_CHARSET));		$conn = mysql_connect($engrave_db_host, $engrave_db_user, $engrave_db_pass, $engrave_db_name);	mysql_query("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary",$conn);	mysql_query('START TRANSACTION',$conn);		$link[0]['text'] = $_LANG['back_package_list'];	$link[0]['href'] = 'engrave_package_list.php?act=list';			$pck_id = isset($_REQUEST['package_id']) ? trim($_REQUEST['package_id']) : 0;	$pck_ids = explode(",",$pck_id);	foreach ($pck_ids AS $key => $val)	{		if(!engrave_package_instorage_byid_trans(intval($val),$conn))		{			transaction_failed($conn);			sys_msg($_LANG['save_failed'], 0, $link);		}	}	transaction_success($conn);	sys_msg($_LANG['save_success'], 0, $link);}/**************************************************************************************** * 批量：删除 ***************************************************************************************/elseif($_REQUEST['act'] == 'batch_remove'){	//建立数据库连接	$charset = 'gbk';	$charset = strtolower(str_replace('-', '', EC_CHARSET));		$conn = mysql_connect($engrave_db_host, $engrave_db_user, $engrave_db_pass, $engrave_db_name);	mysql_query("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary",$conn);	mysql_query('START TRANSACTION',$conn);		$link[0]['text'] = $_LANG['back_package_list'];	$link[0]['href'] = 'engrave_package_list.php?act=list';			$pck_id = isset($_REQUEST['package_id']) ? trim($_REQUEST['package_id']) : 0;	$pck_ids = explode(",",$pck_id);	foreach ($pck_ids AS $key => $val)	{		if(!engrave_package_delete_trans(intval($val),$conn))		{			transaction_failed($conn);			sys_msg($_LANG['save_failed'], 0, $link);		}	}	transaction_success($conn);	sys_msg($_LANG['save_success'], 0, $link);}elseif($_REQUEST['act'] == 'IsExistPackExpressNumber'){	$expressNumber = isset($_REQUEST['packExpressNumber']) ? trim($_REQUEST['packExpressNumber']) : '';	$form_action = isset($_REQUEST['form_action']) ? trim($_REQUEST['form_action']) : "insert";		//存在	$value = true;	if($form_action == "insert")	{		$value = engrave_package_expressnumber_isexist($expressNumber,0);	}else{		$value = engrave_package_expressnumber_isexist($expressNumber,1);	}	if($value == true)	{		make_json_error($GLOBALS['_LANG']['expressNumber_exist']);	}else{		make_json_result('');	}}/** * 事务失败 * @param unknown $conn */function transaction_failed($conn){	//添加失败	mysql_query('ROLLBACK',$conn);//回滚	mysql_close($conn);}/** * 事务成功 * @param unknown $conn */function transaction_success($conn){	//添加失败	mysql_query('COMMIT',$conn);//回滚	mysql_close($conn);}?>