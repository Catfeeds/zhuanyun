<?php /** * ENGRAVE 数据访问：我的账户---账户日志 * =========================================================== * * 版权所有 2014-2019 青岛友腾信息科技有限公司，并保留所有权利。 * 网站地址: http://www.qdutsoft.com； * ---------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 * ========================================================== * $Author: zhangxingpeng $ * $Id: lib_account.php 17217 2014年11月28日 11时03分00秒 zhangxingpeng $ *//** * 查询 花费 * @param number $user_id：用户ID * @param number $change_type：类型 * @return unknown：总花费 */function engrave_account_log_costmoney($user_id=0,$change_type=0){	$sql="select sum(user_money) as user_money".	" from ".$GLOBALS['engrave_shop']->table('account_log').	" where user_id=".$user_id.	" and change_type>=".$change_type.	" and change_type<".($change_type+10);		$result = $GLOBALS['engrave_shop_db']->getOne($sql);	$result = abs($result);	return $result;}/** * 添加 * @param unknown $account_log：账户日志对象 * @return boolean：若添加成功，返回true，反之，返回false！ */function engrave_account_log_insert($account_log){	$time = gmtime();		$sql="insert into ".$GLOBALS['engrave_shop']->table('account_log').	"(user_id,user_money,frozen_money,rank_points,pay_points,change_time,change_desc,change_type)".	" values (".	$account_log['user_id'].",'".$account_log['recharge_value'].	"','".$account_log['recharge_value']."','0','0','".$time."','".	$account_log['member_remark']."',10".	")";		$result = $GLOBALS['engrave_shop_db']->query($sql);		if($result !== false)	{		return true;	}	else{		return false;	}}/** * 添加：带事务 * @param unknown $account_log：账户日志对象 * @param number $change_type：日志类型 * @param unknown $conn：数据库连接对象 * @return boolean：若添加成功，返回true，反之，返回false！ */function engrave_account_log_transinsert($account_log,$change_type=0,$conn){	$time = gmtime();		$sql="insert into ".$GLOBALS['engrave_shop']->table('account_log').	"(user_id,user_money,frozen_money,rank_points,pay_points,change_time,change_desc,change_type)".	" values (".	$account_log['user_id'].",'".$account_log['user_money'].	"','".$account_log['frozen_money'].	"','".$account_log['rank_points'].	"','".$account_log['pay_points'].	"','".$time."','".	$account_log['member_remark']."',".$change_type.	")";		$result = mysql_query($sql,$conn);		if($result !== false)	{		return true;	}	else{		return false;	}}/** * 查询 * @param number $user_id：用户ID查询 * @param number $type：类型 * @param number $startPage：起始页码 * @return unknown:账户对象集合 */function engrave_account_list_byprocess_type($user_id = 0,$startPage=0){	/* 记录总数 */	$sql_count = "SELECT COUNT(*) FROM " .$GLOBALS['engrave_shop']->table('user_account').	" where isdelete=0 and user_id = ".$user_id;		$filter = array();	$filter['sort_by']      = empty($_REQUEST['sort_by']) ? 'id' : trim($_REQUEST['sort_by']);	$filter['sort_order']   = empty($_REQUEST['sort_order']) ? 'DESC' : trim($_REQUEST['sort_order']);		$filter['record_count'] = $GLOBALS['engrave_shop_db']->getOne($sql_count);	/* 分页大小 */	$filter['start'] = $startPage;	$total = $filter['record_count'];	$pageSize = $GLOBALS['_CFG']['page_size'];		$sql = "select id,user_id,admin_user,amount,add_time,paid_time,".	"admin_note,user_note,case when process_type=0 then '充值' else '提现/退款' end process_type,".	"payment,case when is_paid=0 then '未确认' when is_paid=1 then '已完成' else '已取消' end is_paid from ".	$GLOBALS['engrave_shop']->table('user_account').	" where isdelete=0 and user_id = ".$user_id.	" order by " .$filter['sort_by'].' '.$filter['sort_order'] .	" LIMIT " . $filter['start'] . ",".$pageSize;		$account_list = $GLOBALS['engrave_shop_db'] -> getAll($sql);		foreach($account_list as $key=>$val)	{		$account_list[$key]['add_time'] = local_date('Y-m-d H:i:s',$val['add_time']);		$account_list[$key]['paid_time'] = local_date('Y-m-d H:i:s',$val['paid_time']);	}	return array('account_list' => $account_list, 'filter' => $filter, 'page_count' => ceil($total/$pageSize), 'record_count' => $filter['record_count']);}/** * 查询 * @param number $user_id：用户ID查询 * @param number $process_type：类型 * @param number $startPage：起始页码 * @return unknown:账户对象集合 */function engrave_account_list_eq_process_type($user_id = 0,$process_type = 0,$startPage=0){	/* 记录总数 */	$sql_count = "SELECT COUNT(*) FROM " .$GLOBALS['engrave_shop']->table('user_account').	" where isdelete=0 and user_id = ".$user_id." and process_type=".$process_type;	$filter = array();	$filter['sort_by']      = empty($_REQUEST['sort_by']) ? 'id' : trim($_REQUEST['sort_by']);	$filter['sort_order']   = empty($_REQUEST['sort_order']) ? 'DESC' : trim($_REQUEST['sort_order']);	$filter['record_count'] = $GLOBALS['engrave_shop_db']->getOne($sql_count);		/* 分页大小 */	$filter['start'] = $startPage;	$total = $filter['record_count'];	$pageSize = $GLOBALS['_CFG']['page_size'];	$sql = "select id,user_id,admin_user,isexchange,amount,add_time,paid_time,".			"admin_note,user_note,case when process_type=0 then '充值' else '提现/退款' end process_type,".			"payment,case when is_paid=0 then '未确认' when is_paid=1 then '已完成' else '已取消' end is_paid from ".			$GLOBALS['engrave_shop']->table('user_account').			" where isdelete=0 and user_id = ".$user_id.			" and process_type=".$process_type.			" order by " .$filter['sort_by'].' '.$filter['sort_order'] .			" LIMIT " . $filter['start'] . ",".$pageSize;	$account_list = $GLOBALS['engrave_shop_db'] -> getAll($sql);	$time = gmtime();	foreach($account_list as $key=>$val)	{		$add_time = $val['paid_time'];				$account_list[$key]['add_time'] = local_date('Y-m-d H:i:s',$val['add_time']);		$account_list[$key]['paid_time'] = local_date('Y-m-d H:i:s',$val['paid_time']);		$account_list[$key]['ischange'] = "false";		$account_list[$key]['status']='已兑换';		if($val['isexchange'] == '0')		{			$account_list[$key]['status']='未兑换';			if($val['is_paid']=='已完成')			{				if(floor($time-$add_time) < 7 * 86400)				{					$account_list[$key]['ischange'] = "true";				}else{					$account_list[$key]['status']='兑换过期';				}			}		}	}	return array('account_list' => $account_list, 'filter' => $filter, 'page_count' => ceil($total/$pageSize), 'record_count' => $filter['record_count']);}/** * 查询 * @return unknown:账户对象集合 */function engrave_account_log_list_byid($id=0){	$sql = "select * from ".	$GLOBALS['engrave_shop']->table('account_log').	" where log_id=".$id;	$account = $GLOBALS['engrave_shop_db'] -> getRow($sql);		//$account['add_time'] = local_date('Y-m-d H:i:s',$account['add_time']);	//$account['paid_time'] = local_date('Y-m-d H:i:s',$account['paid_time']);		return $account;}/** * 查询 * @return unknown:账户对象集合 */function engrave_account_list_byid($id=0){	$sql = "select id,user_id,admin_user,amount,add_time,paid_time,".	"admin_note,user_note,case when process_type=0 then '充值' else '提现/退款' end process_type,".	"payment,case when is_paid=0 then '未确认' when is_paid=1 then '已完成' else '已取消' end is_paid from ".	$GLOBALS['engrave_shop']->table('user_account').	" where id=".$id;		$account = $GLOBALS['engrave_shop_db'] -> getRow($sql);		$account['add_time'] = local_date('Y-m-d H:i:s',$account['add_time']);	$account['paid_time'] = local_date('Y-m-d H:i:s',$account['paid_time']);		return $account;}/** * 添加 * @param unknown $account：账户 * @return number：返回账户ID */function engrave_account_insert($account){	$time = gmtime();	$sql = "insert into ".$GLOBALS['engrave_shop']->table('user_account').	"(user_id,admin_user,amount,add_time,paid_time,".	"admin_note,user_note,process_type,payment,is_paid,isdelete) values ('".	$account['user_id'].	"','','".$account['amount'].	"','".$time.	"','','','".$account['user_note'].	"','".$account['process_type']."','".$account['payment']."','0','0'".	");";	//echo $sql;	$result = $GLOBALS['engrave_shop_db']->query($sql);	$account_id = $GLOBALS['engrave_shop_db'] -> getOne("select @@identity");	return $account_id;}/** * 删除 * @param number $id:ID * @return boolean：若删除，则返回true，反之返回false！ */function engrave_account_delete($id=0){	$sql = "update ".$GLOBALS['engrave_shop']->table('user_account').	" set isdelete = 1".	" where id='".$id."'";		$result = $GLOBALS['engrave_shop_db']->query($sql);	if($result !== false)	{		return true;	}	else{		return false;	}}/** * 修改 * @param unknown $account：账户 * @return boolean：若修改成功，返回true，反之，返回false！ */function engrave_account_update($account){	$time = gmtime();	$sql = "update ".$GLOBALS['engrave_shop']->table('user_account').	" set is_paid='1".	"', admin_note='".$account['admin_note'].	"', paid_time='".$time.	"',acc_tradenumber='".$account['acc_tradenumber'].	"' where id='".$account['account_id']."'";		$result = $GLOBALS['engrave_shop_db']->query($sql);	if($result !== false)	{		return true;	}	else{		return false;	}}/** * 兑换：修改兑换状态 * @param number $account_id：账户ID * @param unknown $conn：数据库连接对象 * @return boolean：若修改兑换状态成功，返回true，反之，返回false！ */function engrave_account_exchange($account_id = 0,$conn){	$sql = "update ".$GLOBALS['engrave_shop']->table('user_account').	" set isexchange='1'".	" where id='".$account_id."'";	$result = mysql_query($sql,$conn);		if($result !== false)	{		return true;	}	else{		return false;	}}/** * 取消兑换：修改兑换状态 * @param number $account_id：账户ID * @param unknown $conn：数据库连接对象 * @return boolean：若修改兑换状态成功，返回true，反之，返回false！ */function engrave_account_cancel_exchange($account_id = 0,$conn){	$sql = "update ".$GLOBALS['engrave_shop']->table('user_account').	" set isexchange='0'".	" where id='".$account_id."'";	$result = mysql_query($sql,$conn);	if($result !== false)	{		return true;	}	else{		return false;	}}?>